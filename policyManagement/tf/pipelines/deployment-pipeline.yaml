trigger:
  branches:
    include:
      - main
  paths:
    include:
      - policyManagement/tf/**

pool: 'selfhosted'

variables:
  workingDirectory: '$(System.DefaultWorkingDirectory)/policyManagement/tf/'

stages:
- stage: dev_plan 
  displayName: 'dev_plan'
  jobs:
  - job: plan
    displayName: 'plan and validate'
    steps:
    - checkout: self
    - task: AzurePowerShell@5
      displayName: 'plan and validate'
      inputs:
        azureSubscription: 'mi-platform-mg-wi-nonprod-001'
        scriptType: 'inlineScript'
        inline: |
          terraform init
          terraform validate
          terraform plan -var="environment=dev"
        errorActionPreference: 'stop'
        failOnStandardError: true
        azurePowerShellVersion: 'latestVersion'
        pwsh: true
        workingDirectory: $(workingDirectory)

- stage: dev_deploy
  displayName: 'dev_deploy'
  jobs:
  - job: apply 
    displayName: 'apply'
    steps:
    - checkout: self
    - task: AzurePowerShell@5
      displayName: 'apply'
      inputs:
        azureSubscription: 'mi-platform-mg-wi-nonprod-001'
        scriptType: 'inlineScript'
        inline: |
          terraform init
          terraform apply -auto-approve -var="environment=dev"
        errorActionPreference: 'stop'
        failOnStandardError: true
        azurePowerShellVersion: 'latestVersion'
        pwsh: true
        workingDirectory: $(workingDirectory)
