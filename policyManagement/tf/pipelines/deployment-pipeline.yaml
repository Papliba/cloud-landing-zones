trigger:
  branches:
    include:
      - main
  paths:
    include:
      - policyManagement/tf/**

pool: 'selfhosted'

variables:
  workingDirectory: '$(System.DefaultWorkingDirectory)/policyManagement/tf/'

stages:
- stage: dev_plan
  displayName: 'dev_plan'
  jobs:
  - job: plan
    displayName: 'plan and validate'
    steps:
    - checkout: self

    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Import-Module "$(System.DefaultWorkingDirectory)/policyManagement/scripts/JsoncConverter/JsoncConverter.psd1"
          Convert-JsoncToJson -Path "$(System.DefaultWorkingDirectory)/policyManagement/tf/policies/definitions" -Recurse
        failOnStderr: false
      displayName: 'Convert JSONC to JSON'

    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    AZURE POLICY DEPLOYMENT SUMMARY                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          POLICIES_DIR="$(System.DefaultWorkingDirectory)/policyManagement/tf/policies/definitions"

          # Count files
          TOTAL_JSON=$(find "$POLICIES_DIR" -type f -name "*.json" | wc -l | xargs)
          TOTAL_JSONC=$(find "$POLICIES_DIR" -type f -name "*.jsonc" | wc -l | xargs)
          POLICY_JSON=$(find "$POLICIES_DIR" -path "*/policies/*.json" | wc -l | xargs)
          INITIATIVE_JSON=$(find "$POLICIES_DIR" -path "*/initiatives/*.json" | wc -l | xargs)

          # Calculate converted files (JSON files that have corresponding JSONC)
          CONVERTED_FILES=$(find "$POLICIES_DIR" -name "*.jsonc" | wc -l | xargs)

          echo "ğŸ“Š CONVERSION RESULTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… JSONC files converted to JSON: $CONVERTED_FILES"
          echo "  ğŸ“„ Total JSON files available:    $TOTAL_JSON"
          echo "  ğŸ“ Source JSONC files:            $TOTAL_JSONC"
          echo ""

          echo "ğŸ“‹ POLICY INVENTORY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ”’ Policy Definitions:       $POLICY_JSON files"
          echo "  ğŸ“¦ Initiative Definitions:   $INITIATIVE_JSON files"
          echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ“Š Total Governance Assets:  $(($POLICY_JSON + $INITIATIVE_JSON)) definitions"
          echo ""

          # List management groups
          echo "ğŸ¢ DEPLOYMENT SCOPE (Management Groups)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          for mgdir in $(find "$POLICIES_DIR/scope" -maxdepth 1 -type d | tail -n +2 | sort); do
            mgname=$(basename "$mgdir")
            policies=$(find "$mgdir/policies" -name "*.json" 2>/dev/null | wc -l | xargs)
            initiatives=$(find "$mgdir/initiatives" -name "*.json" 2>/dev/null | wc -l | xargs)
            echo "  ğŸ“ $mgname"
            echo "     â””â”€ Policies: $policies | Initiatives: $initiatives"
          done
          echo ""

          # Policy categories breakdown (if we can parse JSON)
          echo "ğŸ“ POLICY CATEGORIES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Count by category (extract from metadata)
          categories=$(find "$POLICIES_DIR" -path "*/policies/*.json" -type f -exec jq -r '.properties.metadata.category // "Uncategorized"' {} \; 2>/dev/null | sort | uniq -c | sort -rn)

          if [ -n "$categories" ]; then
            echo "$categories" | while read count category; do
              # Format with icons based on category
              case "$category" in
                *Security*) icon="ğŸ”’" ;;
                *Cost*|*Management*) icon="ğŸ’°" ;;
                *Network*) icon="ğŸŒ" ;;
                *Governance*) icon="ğŸ“‹" ;;
                *Monitoring*) icon="ğŸ“Š" ;;
                *Compliance*) icon="âœ…" ;;
                *Identity*) icon="ğŸ‘¤" ;;
                *Storage*) icon="ğŸ’¾" ;;
                *Compute*) icon="ğŸ–¥ï¸" ;;
                *Container*) icon="ğŸ“¦" ;;
                *Data*) icon="ğŸ“" ;;
                *Environment*) icon="ğŸŒ" ;;
                *Naming*) icon="ğŸ·ï¸" ;;
                *Tagging*) icon="ğŸ·ï¸" ;;
                *) icon="ğŸ“„" ;;
              esac
              printf "  %s %-25s %3d policies\n" "$icon" "$category" "$count"
            done
          else
            echo "  Unable to parse categories (jq not available)"
          fi
          echo ""

          echo "âœ… VALIDATION STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Validate JSON files
          invalid_count=0
          echo "  Validating JSON files..."
          for jsonfile in $(find "$POLICIES_DIR" -name "*.json" -type f); do
            if ! jq -e . "$jsonfile" >/dev/null 2>&1; then
              echo "  âŒ Invalid: $(basename $jsonfile)"
              invalid_count=$((invalid_count + 1))
            fi
          done

          if [ $invalid_count -eq 0 ]; then
            echo "  âœ… All $TOTAL_JSON JSON files are valid"
          else
            echo "  âš ï¸  Found $invalid_count invalid JSON file(s)"
          fi
          echo ""

          echo "ğŸš€ READY FOR DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  All JSONC files have been converted to JSON format"
          echo "  Terraform will deploy policies to their respective management groups"
          echo "  based on folder structure (convention-based deployment)"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
        workingDirectory: $(System.DefaultWorkingDirectory)
      displayName: 'Azure Policy Deployment Summary'

#     - task: AzureCLI@2
#       inputs:
#         azureSubscription: 'mi-platform-mg-wi-nonprod-001'
#         scriptType: 'bash'
#         scriptLocation: 'inlineScript' # 'scriptPath'
#         # scriptPath: '/pathtoscript'
#         inlineScript: |
#           terraform init
#           terraform validate
#           terraform plan -out=tfplan
#           # terraform plan -out=tfplan -var="environment=dev"
#         # arguments: # string. Alias: scriptArguments. Script Arguments.
#         workingDirectory: $(workingDirectory)
#         failOnStandardError: false # boolean. Fail on Standard Error. Default: false.
#       displayName: 'plan'
#       env:
#         ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

#     - task: PublishPipelineArtifact@1
#       inputs:
#         targetPath: '$(workingDirectory)/tfplan'
#         artifact: 'terraform-plan'
#         publishLocation: 'pipeline'
#       displayName: 'Publish Terraform Plan' 

# - stage: dev_deploy
#   displayName: 'dev_deploy'
#   dependsOn: dev_plan
#   jobs:
#   - job: apply
#     displayName: 'apply'
#     steps:
#     - checkout: self

#     - task: DownloadPipelineArtifact@2
#       inputs:
#         buildType: 'current'
#         artifactName: 'terraform-plan'
#         targetPath: '$(workingDirectory)'
#       displayName: 'Download Terraform Plan'

#     - task: AzureCLI@2
#       inputs:
#         azureSubscription: 'mi-platform-mg-wi-nonprod-001'
#         scriptType: 'bash'
#         scriptLocation: 'inlineScript' # 'scriptPath'
#         # scriptPath: '/pathtoscript'
#         inlineScript: |
#           terraform init
#           terraform apply -auto-approve tfplan
#         # arguments: # string. Alias: scriptArguments. Script Arguments.
#         workingDirectory: $(workingDirectory)
#         failOnStandardError: false # boolean. Fail on Standard Error. Default: false.
#       displayName: 'apply'
#       env:
#         ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)
