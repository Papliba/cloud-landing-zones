trigger:
  branches:
    include:
      - main
  paths:
    include:
      - policyManagement/tf/**

pool: 'selfhosted'

variables:
  workingDirectory: '$(System.DefaultWorkingDirectory)/policyManagement/tf/'

stages:
- stage: dev_plan
  displayName: 'dev_plan'
  jobs:
  - job: plan
    displayName: 'plan and validate'
    steps:
    - checkout: self

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'mi-platform-mg-wi-nonprod-001'
        scriptType: 'bash'
        scriptLocation: 'inlineScript' # 'scriptPath'
        # scriptPath: '/pathtoscript'
        inlineScript: |
          terraform init
          terraform validate
          terraform plan -out=tfplan
          # terraform plan -out=tfplan -var="environment=dev"
        # arguments: # string. Alias: scriptArguments. Script Arguments.
        workingDirectory: $(workingDirectory)
        failOnStandardError: false # boolean. Fail on Standard Error. Default: false.
      displayName: 'plan'
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(workingDirectory)/tfplan'
        artifact: 'terraform-plan'
        publishLocation: 'pipeline'
      displayName: 'Publish Terraform Plan' 

- stage: dev_deploy
  displayName: 'dev_deploy'
  dependsOn: dev_plan
  jobs:
  - job: apply
    displayName: 'apply'
    steps:
    - checkout: self

    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'terraform-plan'
        targetPath: '$(workingDirectory)'
      displayName: 'Download Terraform Plan'

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'mi-platform-mg-wi-nonprod-001'
        scriptType: 'bash'
        scriptLocation: 'inlineScript' # 'scriptPath'
        # scriptPath: '/pathtoscript'
        inlineScript: |
          terraform init
          terraform apply -auto-approve tfplan
        # arguments: # string. Alias: scriptArguments. Script Arguments.
        workingDirectory: $(workingDirectory)
        failOnStandardError: false # boolean. Fail on Standard Error. Default: false.
      displayName: 'apply'
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY) 

